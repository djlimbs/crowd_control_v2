var Resource = require('deployd/lib/resource')
	, Script = require('deployd/lib/script')
	, util = require('util')
	, http = require('http')
	, request = require('request');

function Ajax() {
	Resource.apply(this, arguments);
}
util.inherits(Ajax, Resource);

//EventResource.label = "Event";
Ajax.events = ["get", "post"];

module.exports = Ajax;

Ajax.prototype.clientGeneration = true;

Ajax.prototype.handle = function (ctx, next) {
	var parts = ctx.url.split('/').filter(function(p) { return p; });

	var resultString = '';
	var query = ctx.query;
	var body = ctx.body;

	var options = {};
	
	var domain = {
			url: ctx.url
		, parts: parts
		, query: ctx.query
		, body: ctx.body
		, ajax: function(options) {
			request(options, function(error, response, body) {
				if (error) {
					console.log('ERROR');
					console.log(error);
				}

				if (response && response.statusCode === 200 && body) {
					ctx.done(null, { response: body.trim()});
				} else {
					ctx.done(null, { error: error});
				}
			});
		}
	};

	if (ctx.method === "POST" && this.events.post) {
		
	} else if (ctx.method === "GET" && this.events.get) {
		this.events.get.run(ctx, domain, function(err) {
			if (err) {
				console.log(err);
			}
		});
	} else {
		next();
	}

	
};